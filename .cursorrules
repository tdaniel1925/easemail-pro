# EaseMail Development Guidelines

## General Development Guidelines

- Only modify code directly relevant to the specific request. Avoid changing unrelated functionality.
- Never replace code with placeholders like `# ... rest of the processing ...`. Always include complete code.
- Break problems into smaller steps. Think through each step separately before implementing.
- Always provide a complete PLAN with REASONING based on evidence from code and logs before making changes.
- Explain your OBSERVATIONS clearly, then provide REASONING to identify the exact issue. Add console logs when needed to gather more information.

---

# EaseMail Email Formatting Standards

## Context

You are working on EaseMail, an AI-powered email client. All emails generated, composed, or formatted by the system MUST follow strict formatting rules for professional appearance and consistency.

## Critical Formatting Rules

### Rule 1: Blank Line AFTER the Salutation/Greeting

There must be exactly ONE blank line between the salutation (greeting) and the body of the email.

**Salutations include:**
- "Hi [Name],"
- "Hello [Name],"
- "Dear [Name],"
- "Hey [Name],"
- "Good morning/afternoon/evening [Name],"
- "To Whom It May Concern,"
- Any similar greeting pattern

### Rule 2: Blank Line BEFORE the Closing/Sign-off

There must be exactly ONE blank line between the last paragraph of the body and the closing/sign-off.

**Closings include:**
- "Best regards,"
- "Sincerely,"
- "Thanks,"
- "Thank you,"
- "Best,"
- "Regards,"
- "Cheers,"
- "Warm regards,"
- "Kind regards,"
- Any similar closing pattern

---

## Correct Format Example

```
Hi John,

I wanted to follow up on our conversation from yesterday about the project timeline. We've made significant progress on the backend integration.

Please let me know if you have any questions or concerns about the proposed schedule.

Best regards,
Daniel
CEO, BotMakers Inc.
```

**Structure breakdown:**
```
[SALUTATION]
[BLANK LINE]
[BODY PARAGRAPH 1]
[BLANK LINE - only if multiple paragraphs]
[BODY PARAGRAPH 2]
[BLANK LINE]
[CLOSING]
[SIGNATURE]
```

---

## Incorrect Format Examples

### ❌ WRONG: No blank line after salutation

```
Hi John,
I wanted to follow up on our conversation from yesterday about the project timeline.
```

### ❌ WRONG: No blank line before closing

```
Please let me know if you have any questions or concerns.
Best regards,
Daniel
```

### ❌ WRONG: Multiple blank lines (too many)

```
Hi John,


I wanted to follow up on our conversation.


Best regards,
Daniel
```

### ❌ WRONG: No spacing at all

```
Hi John,
I wanted to follow up on our conversation.
Best regards,
Daniel
```

---

## Implementation Guidelines

### When generating email content:

1. **Always split the email into logical sections:**
   - Salutation
   - Body (one or more paragraphs)
   - Closing
   - Signature

2. **Apply formatting programmatically:**
   ```typescript
   function formatEmail(
     salutation: string,
     bodyParagraphs: string[],
     closing: string,
     signature: string
   ): string {
     const formattedBody = bodyParagraphs.join('\n\n');

     return `${salutation}\n\n${formattedBody}\n\n${closing}\n${signature}`;
   }
   ```

3. **When parsing or reformatting existing emails:**
   - Detect the salutation pattern (first line ending with comma or colon)
   - Detect the closing pattern (common closings followed by comma)
   - Normalize spacing: collapse multiple blank lines to single blank lines
   - Ensure exactly one blank line after salutation
   - Ensure exactly one blank line before closing

### Regex patterns for detection:

```typescript
// Salutation patterns
const salutationPatterns = [
  /^(Hi|Hello|Hey|Dear|Good\s+(morning|afternoon|evening))\s+[\w\s]+[,:]?\s*$/i,
  /^To\s+Whom\s+It\s+May\s+Concern[,:]?\s*$/i,
  /^(Greetings|Salutations)[,:]?\s*$/i
];

// Closing patterns
const closingPatterns = [
  /^(Best\s+regards?|Sincerely|Thanks?|Thank\s+you|Regards?|Cheers|Warm(est)?\s+regards?|Kind(est)?\s+regards?|All\s+the\s+best|Take\s+care)[,]?\s*$/i
];
```

### Formatting function for AI-generated content:

```typescript
function ensureProperEmailFormatting(rawEmail: string): string {
  const lines = rawEmail.split('\n');
  const result: string[] = [];

  let salutationIndex = -1;
  let closingIndex = -1;

  // Find salutation (usually first non-empty line)
  for (let i = 0; i < lines.length; i++) {
    if (isSalutation(lines[i].trim())) {
      salutationIndex = i;
      break;
    }
  }

  // Find closing (scan from bottom)
  for (let i = lines.length - 1; i >= 0; i--) {
    if (isClosing(lines[i].trim())) {
      closingIndex = i;
      break;
    }
  }

  // Rebuild with proper spacing
  for (let i = 0; i < lines.length; i++) {
    result.push(lines[i]);

    // Add blank line after salutation
    if (i === salutationIndex) {
      if (lines[i + 1]?.trim() !== '') {
        result.push('');
      }
    }

    // Add blank line before closing
    if (i === closingIndex - 1 && lines[i].trim() !== '') {
      result.push('');
    }
  }

  // Clean up multiple consecutive blank lines
  return result.join('\n').replace(/\n{3,}/g, '\n\n');
}
```

---

## Edge Cases to Handle

1. **Reply emails with quoted content:**
   - Apply formatting only to the new content being composed
   - Do not modify the quoted/forwarded content below

2. **Emails without explicit salutation:**
   - Some emails start directly with content
   - Do not force a salutation if none exists

3. **Emails without closing:**
   - Some quick replies may not have a formal closing
   - Do not force a closing if none exists

4. **HTML emails:**
   - When working with HTML content, use `<br><br>` or `<p>` tags appropriately
   - Ensure the visual spacing matches the plain text rules

5. **Mobile/short replies:**
   - Very short replies like "Thanks!" or "Got it!" may not follow the full format
   - Apply formatting rules proportionally

---

## Testing Checklist

When reviewing email formatting code, verify:

- [ ] Blank line exists after salutation
- [ ] Blank line exists before closing
- [ ] No double/triple blank lines anywhere
- [ ] Body paragraphs are separated by single blank lines
- [ ] Signature immediately follows closing (no blank line between closing and signature)
- [ ] Formatting works for both plain text and HTML modes
- [ ] AI-generated emails automatically follow this format
- [ ] User-composed emails are gently normalized on send (optional)

---

## Summary

**The golden rule:** Every email should breathe. One blank line after the greeting lets the reader transition into the content. One blank line before the sign-off provides a clear visual endpoint to the message body. This creates professional, readable emails that reflect well on EaseMail users.

```
[Greeting],
                    ← ONE blank line
[Body content...]
                    ← ONE blank line
[Closing],
[Signature]
```

Apply these rules consistently across all email generation, composition, and formatting functions in the EaseMail codebase.
